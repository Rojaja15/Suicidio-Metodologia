# Analisis descriptivo

# Limpieza

## Librerias

```{r}

library(tidyverse)
library(fastDummies)
library(FactoMineR)
library(factoextra)
library(cluster)
library(dendextend)
library(caret)
library(reticulate)
library(htmltools)
library(IRdisplay)
library(readxl)
library(dplyr)
library(ggplot2)
library(tidyr)
library(lubridate)
library(psych)
library(ggcorrplot)
library(janitor)
library(summarytools)
library(broom)
library(readxl)
library(cowplot)

```

## Funciones

```{r}

inercia_intraclase <- function(datos, grupos) {
  # Combina los datos y los grupos en una sola tabla
  tabla <- cbind(datos, grupos)

  # Calcula los centroides (puntos medios) de cada grupo
  centroides <- lapply(unique(grupos), function(id_grupo) {
    subconjunto <- subset(tabla, grupos == id_grupo)
    apply(subconjunto[, 1:(ncol(subconjunto)-1)], 2, mean)
  })

  # Calcula la suma de las distancias al cuadrado de cada punto a su centroide
  suma_cuadrados <- sum(sapply(unique(grupos), function(id_grupo) {
    subconjunto <- subset(tabla, grupos == id_grupo, select = -grupos)
    centroide_actual <- centroides[[id_grupo]]

    # Resta el centroide a cada punto y calcula la suma de cuadrados
    sum(sweep(subconjunto, 2, centroide_actual, "-")^2)
  }))

  return(suma_cuadrados)
}

```

```{r}

options(tibble.width = Inf)

```

```{r}

datos_crudos <- read_excel("Datos.xlsx")

```

```{r}

head(datos_crudos)

```

## Limpiar datos

```{r}

# Asumiendo que tus datos originales están en el dataframe "mis_datos"
df <- datos_crudos %>%
  rename(

    fecha = `Marca temporal`,
    salud_fisica = `1. Mi salud física afecta mi estado de ánimo.`,
    maltrato_emocional = `2. Durante la niñez y adolescencia, viví experiencias en las que fui maltratado o humillado emocionalmente.`,
    castigo_fisico = `3. Durante la niñez y adolescencia, recibí castigos físicos o golpes que me causaron daño o miedo.`,
    abuso_sexual = `4. Durante la niñez y adolescencia, fui víctima de contacto sexual forzado o inapropiado por parte de alguien mayor.`,
    ocultar_emociones = `5. Siento que debo ocultar mis emociones para no parecer débil.`,
    dificultad_pedir_ayuda = `6. Me cuesta pedir ayuda cuando enfrento una dificultad.`,
    guarda_sentimientos = `7. Cuando estoy triste o dolido, prefiero guardármelo para mí.`,

    # Sección 2: Frecuencia en los últimos 7 días
    sin_motivacion = `1. ¿Cuántas veces en los últimos 7 días, me he sentido sin motivación para realizar mis actividades?`,
    preocupado = `2. ¿Cuántas veces en los últimos 7 días, me he sentido preocupado?`,
    sin_proposito = `3. ¿Cuántas veces en los últimos 7 días, he sentido que la vida ha perdido su sentido y propósito?`,
    no_reconocer_logros = `4. ¿Cuántas veces en los últimos 7 días, me ha costado reconocer mis logros y aspectos positivos?`,
    incapaz_solucionar = `5. ¿Cuántas veces en los últimos 7 días, he pensado que soy incapaz de encontrar una solución a mis problemas?`,
    intento_autolesion = `6. ¿Cuántas veces en los últimos 7 días, he intentado hacerme daño?`,
    plan_autolesion = `7. ¿Cuántas veces en los últimos 7 días, he hecho planes para hacerme daño?`,
    autolesion_fisica = `8. ¿Cuántas veces en los últimos 7 días, me he hecho daño físico de manera intencional (por ejemplo, cortarme, golpearme o provocarme dolor)?`,
    conduccion_temeraria = `9. ¿Cuántas veces en los últimos 7 días, he conducido de manera arriesgada o sin cuidado por mi seguridad?`,
    soledad = `10. ¿Cuántas veces en los últimos 7 días, me he sentido solo o sin apoyo?`,
    conflicto_familiar = `11. ¿Cuántas veces en los últimos 7 días, he tenido conflictos o discusiones en mi familia?`,
    dificultad_economica = `12. ¿Cuántas veces en los últimos 7 días, he tenido dificultades económicas que me preocupan?`,
    exigencia_academica_laboral = `13. ¿Cuántas veces en los últimos 7 días, tuve muchas exigencias académicas o laborales`,
    descontrol_drogas = `14. ¿Cuántas veces en los últimos 7 días, he sentido que pierdo el control al consumir algunas drogas?`,
    abuso_alcohol = `15.  ¿Cuántas veces en los últimos 7 días, he abusado del consumo de bebidas alcohólicas?`,
    descontrol_enojo = `16. ¿Cuántas veces en los últimos 7 días, cuando me enojo o me altero, siento que pierdo el control de mis reacciones?`,

    # Sección 3: Historial y situación actual (Sí/No)
    medicamento_psiquiatrico = `1. Alguna vez en mi vida he tomado medicamentos psiquiátricos (ansiolíticos, antidepresivos, etc.)`,
    discapacidad_fisica = `2. Tengo alguna discapacidad física (por ejemplo, pérdida de audición o amputación)`,
    suicidio_familiar = `3. ¿Alguna persona de mi familia ha intentado quitarse la vida o se ha suicidado?`,
    ruptura_reciente = `4. En el último mes, he pasado por una ruptura o separación de pareja que me ha impactado emocionalmente.`,
    crisis_pareja_actual = `5. Actualmente estoy pasando por una crisis en mi relación de pareja.`,
    medidas_cautelares = `6. Tengo vigentes medidas cautelares por violencia doméstica u otras razones legales.`,

    # Sección 4: Ideación (Escala)
    roberts_pensado_muerte = `1. Pensé en la muerte.`,
    roberts_mejor_sin_mi = `2. Mi familia y mis amigos estarían mejor si yo estuviera muerto.`,
    roberts_pensado_matarme = `3. Pensé en matarme.`,
    roberts_plan_suicida = `4. Me mataría si encontrara o tuviera la manera de hacerlo.`,

    # Sección 5: Datos demográficos y de grupo
    edad = `1. Edad (número de años cumplidos)`,
    escolaridad = `2. Grado de escolaridad`,
    estado_civil = `3. Estado civil`,
    ocupacion = `4. Ocupación`,
    orientacion_sexual = `5. Orientación sexual`,
    provincia = `6. Provincia donde vive`,
    canton = `7. Cantón donde vive`,
    grupo_wem = `Grupo al que asiste de Wem`,
    sesiones_cumplidas = `Cantidad de sesiones cumplidas (en número)`,
    dia = `Día de la semana al que más asiste al grupo`
  )

```

```{r}

print(df, n = 20, width = Inf)

```

```{r}

# 1. Definir los grupos de variables para cada tipo de recodificación
vars_freq <- c(
  'salud_fisica', 'maltrato_emocional', 'castigo_fisico', 'abuso_sexual',
  'ocultar_emociones', 'dificultad_pedir_ayuda', 'guarda_sentimientos'
)

vars_dias <- c(
  'sin_motivacion', 'preocupado', 'sin_proposito', 'no_reconocer_logros',
  'incapaz_solucionar', 'intento_autolesion', 'plan_autolesion', 'autolesion_fisica',
  'conduccion_temeraria', 'soledad', 'conflicto_familiar', 'dificultad_economica',
  'exigencia_academica_laboral', 'descontrol_drogas', 'abuso_alcohol', 'descontrol_enojo'
)

vars_roberts <- c(
  'roberts_pensado_muerte', 'roberts_mejor_sin_mi',
  'roberts_pensado_matarme', 'roberts_plan_suicida'
)

# 2. Aplicar la recodificación usando mutate() y across()
df <- df %>%
  mutate(
    # Recodificación para la Sección 2 (Escala de Frecuencia General)
    across(all_of(vars_freq), ~case_when(
      . == "Nunca"         ~ 0,
      . == "Casi nunca"    ~ 1,
      . == "Rara vez"      ~ 2,
      . == "A veces"       ~ 3,
      . == "Con frecuencia"~ 4,
      . == "Casi siempre"  ~ 5,
      . == "Siempre"       ~ 6,
      TRUE                ~ NA_real_ # Por si hay algún valor inesperado
    )),

    # Recodificación para la Sección 3 (Frecuencia en los últimos 7 días)
    across(all_of(vars_dias), ~case_when(
      . == "Nunca"         ~ 0,
      . == "1 - 2 días"    ~ 1,
      . == "3 días"        ~ 2,
      . == "4 días"        ~ 3,
      . == "5 días"        ~ 4,
      . == "6 días"        ~ 5,
      . == "Todos los días"~ 6,
      TRUE                ~ NA_real_
    )),

    # Recodificación para la Sección 5 (Escala Roberts - Frecuencia en la última semana)
    across(all_of(vars_roberts), ~case_when(
      . == "0 días"       ~ 0,
      . == "1-2 días"      ~ 1,
      . == "3-4 días"      ~ 2,
      . == "5-7 días"      ~ 3,
      TRUE                ~ NA_real_
    ))
  )

```

```{r}

df <- df %>%
  mutate(
    EIS_Roberts = rowSums(select(., all_of(vars_roberts)), na.rm = TRUE)
  )

```

```{r}

df <- df %>%
  mutate(
    EIS_Cat = case_when(
      EIS_Roberts <= 5          ~ "Bajo",
      EIS_Roberts >= 6 & EIS_Roberts <= 8 ~ "Medio",
      EIS_Roberts >= 9          ~ "Alto",
      TRUE                      ~ NA_character_ # Manejo de casos inesperados (como NAs)
    )
  )

```

```{r}

df <- df %>%
  mutate(across(where(is.character), as.factor))

```

## Prueba alternativa

```{r}

#df <- df %>%
#  filter(sesiones_cumplidas < 45)

```

```{r}

str(df)

```

## Estandarizar

```{r}

# 1. Definir las variables individuales de Roberts que vamos a excluir
vars_roberts_individuales <- c(
  'roberts_pensado_muerte', 'roberts_mejor_sin_mi',
  'roberts_pensado_matarme', 'roberts_plan_suicida'
)

# 2. Seleccionar el conjunto final de variables para el clúster
#    Excluimos la fecha y los ítems individuales de Roberts.
#    Ahora SÍ mantenemos EIS_Roberts y EIS_Cat.
df_para_cluster <- df %>%
  select(
    -fecha,
    -canton,
    -provincia,
    -grupo_wem,
    -dia,
    -all_of(vars_roberts_individuales)
  )

# 3. Identificar las columnas numéricas y factores en este nuevo conjunto
#    'EIS_Roberts' se tratará como numérica y 'EIS_Cat' como factor.
vars_numericas <- df_para_cluster %>%
  select(where(is.numeric)) %>%
  names()

vars_factores <- df_para_cluster %>%
  select(where(is.factor)) %>%
  names()

# 4. Crear variables dummy a partir de TODOS los factores (incluyendo EIS_Cat)
df_dummies <- dummy_cols(
  df_para_cluster,
  select_columns = vars_factores,
  remove_selected_columns = TRUE) # Elimina las columnas factor originales

```

```{r}

# 5. Aislar y escalar TODAS las variables numéricas (incluyendo EIS_Roberts)
datos_numericos <- df_para_cluster %>% select(all_of(vars_numericas))
datos_escalados <- as.data.frame(scale(datos_numericos))

# 6. Unir los datos numéricos escalados con las nuevas variables dummy
#    Primero, nos quedamos solo con las columnas dummy que se crearon
df_dummies_solo <- df_dummies %>% select(-all_of(vars_numericas))

#    Finalmente, los unimos
df_escalado <- bind_cols(datos_escalados, df_dummies_solo)

```

```{r}

df_escalado <- df_escalado %>%
  rename(
    # Escolaridad
    posgrado = `escolaridad_Posgrado (Maestría / Doctorado)`,
    sec_completa = `escolaridad_Secundaria completa`,
    sec_incompleta = `escolaridad_Secundaria incompleta`,
    tecnico = `escolaridad_Técnico medio / Diplomado`,
    u_completo = `escolaridad_Universitario completo`,
    u_incompleto = `escolaridad_Universitario incompleto`,

    # Estado Civil
    casado = `estado_civil_Casado`,
    divorciado = `estado_civil_Divorciado`,
    separado = `estado_civil_Separado`,
    soltero = `estado_civil_Soltero`,
    union_libre = `estado_civil_Unión libre`,

    # Ocupación
    desempleado = `ocupacion_Desempleado`,
    asalariado = `ocupacion_Trabajador asalariado`,
    independiente = `ocupacion_Trabajador independiente`,

    # Orientación Sexual
    heterosexual = `orientacion_sexual_Heterosexual`,
    sexualidad_otra = `orientacion_sexual_Otra`,

    # EIS Categórico
    EIS_alto = `EIS_Cat_Alto`,
    EIS_bajo = `EIS_Cat_Bajo`,
    EIS_medio = EIS_Cat_Medio
  )

```

```{r}

glimpse(df_escalado)

```

# Analisis descriptivo de datos

Se utiliza el `df`, ya que no tiene variables estandarizadas.

```{r}

df = df %>%
  select(where(~n_distinct(.) > 1))

```

```{r}

df <- df %>%
  janitor::clean_names()

```

```{r}

colSums(is.na(df))

```

# Estadistica descriptiva

```{r}

summary(select_if(df, is.numeric))

```

```{r}

numeric_vars = select_if(df, is.numeric)

```

```{r}

describe(numeric_vars) # Funcion del paquete psych

```

**Ciclo** `for` para visualizacion de variables numericas en un histograma

```{r}

for (var in names(numeric_vars)) {
  print(
    ggplot(df, aes(x = .data[[var]])) +
      geom_histogram(fill = "steelblue", color = "black", bins = 20, na.rm = TRUE) +
      theme_minimal() +
      labs(title = paste("Distribución de", var), x = var, y = "Frecuencia") +
      theme(plot.title = element_text(hjust = 0.5))
  )
}

```

**Despues** de analizar la variables numericas, se realizar analisis de categorica

```{r}

categorical_vars = select_if(df, is.factor)
for (var in names(categorical_vars)) {
  print(ggplot(categorical_vars, aes_string(x = var)) +
          geom_bar(fill = "orange", color = "black") +
          theme_minimal() +
          labs(title = paste("Frecuencia de", var), x = var, y = "Frecuencia") +
          theme(
            axis.text.x = element_text(angle = 45, hjust = 1),
            plot.title = element_text(hjust = 0.5)
          )
  )
}

```

### Escolaridad

```{r}

datos_escolaridad <- df %>%
  select(escolaridad)

datos_escolaridad <- datos_escolaridad %>%
  group_by(escolaridad) %>%
  summarise(conteo = n()) %>%
  mutate(porcentaje = round((conteo / sum(conteo)) * 100, 3))

ggplot(datos_escolaridad, aes(x = "", y = porcentaje, fill = escolaridad)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  labs(
    title = "Distribución de nivel de escolaridad",
    fill = "Escolaridad"   # La leyenda comienza con mayúscula
  ) +
  theme_void() +
  geom_text(
    aes(label = paste0(porcentaje, "%")),
    position = position_stack(vjust = 0.5),
    color = "black",
    size = 3
  ) +
  theme(
    plot.title = element_text(
      hjust = 3,          # Centra el título
      face = "bold",        # Negrita para título
      size = 16
    ),
    legend.title = element_text(face = "bold", size = 12),
    legend.text = element_text(size = 11)
  ) +
  scale_fill_brewer(palette = "Set2")  # Colores más formales (pasteles suaves)

```

### Variables categoricas

```{r}

datos_categoricos <- df %>%
  select(
    medicamento_psiquiatrico,
    discapacidad_fisica,
    suicidio_familiar,
    ruptura_reciente,
    crisis_pareja_actual,
    medidas_cautelares
  )

g1 <- ggplot(datos_categoricos, aes(x = medicamento_psiquiatrico)) +
  geom_bar(fill = "#1F77B4") +
  labs(title = "Uso de Medicamento Psiquiátrico", x = NULL, y = "Frecuencia") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 8))

g2 <- ggplot(datos_categoricos, aes(x = discapacidad_fisica)) +
  geom_bar(fill = "#FF7F0E") +
  labs(title = "Discapacidad Física", x = NULL, y = "Frecuencia") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 8))

g3 <- ggplot(datos_categoricos, aes(x = suicidio_familiar)) +
  geom_bar(fill = "#2CA02C") +
  labs(title = "Suicidio Familiar", x = NULL, y = "Frecuencia") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 8))

g4 <- ggplot(datos_categoricos, aes(x = ruptura_reciente)) +
  geom_bar(fill = "#D62728") +
  labs(title = "Ruptura Reciente", x = NULL, y = "Frecuencia") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 8))

g5 <- ggplot(datos_categoricos, aes(x = crisis_pareja_actual)) +
  geom_bar(fill = "#9467BD") +
  labs(title = "Crisis Pareja Actual", x = NULL, y = "Frecuencia") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 8))

g6 <- ggplot(datos_categoricos, aes(x = medidas_cautelares)) +
  geom_bar(fill = "#7F7F7F") +
  labs(title = "Medidas Cautelares", x = NULL, y = "Frecuencia") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 8))

```

```{r}

plot_grid(g1, g2, g3, g4, g5, g6,
          ncol = 2)

```

